name: CI

on:
  pull_request:
  push:
    branches: [main, v*]

jobs:
  CI:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        toolchain: [stable, nightly]

    steps:
      - uses: actions/checkout@v4

      - run: rustup update && rustup default ${{ matrix.toolchain }}

      - name: check fails without MUJOCO_LIB
        run: |
          if cargo check; then
            echo "cargo check succeeded without mujoco, which is unexpected."
            exit 1
          else
            echo "cargo check failed as expected without mujoco."
          fi
          
      - name: install mujoco and set MUJOCO_LIB
        run: |
          mkdir -p $HOME/.mujoco
          cd $HOME/.mujoco
          wget https://github.com/google-deepmind/mujoco/releases/download/3.3.4/mujoco-3.3.4-linux-x86_64.tar.gz
          tar -xzf mujoco-3.3.4-linux-x86_64.tar.gz
          echo "export MUJOCO_LIB=$HOME/.mujoco/mujoco-3.3.4-linux-x86_64/lib" >> ~/.bashrc
          echo "export LD_LIBRARY_PATH=$HOME/.mujoco/mujoco-3.3.4-linux-x86_64/lib:$LD_LIBRARY_PATH" >> ~/.bashrc
          echo "[DEBUG] ~/.bashrc contents:"
          cat ~/.bashrc
      
      - name: check succeeds with MUJOCO_LIB
        run: |
          echo "[DEBUG] ~/.bashrc contents:"
          cat ~/.bashrc
          source ~/.bashrc
          echo "[DEBUG] MUJOCO_LIB is set to: '$MUJOCO_LIB'"
          echo "[DEBUG] LD_LIBRARY_PATH is set to: '$LD_LIBRARY_PATH'"
          if cargo check; then
            echo "cargo check succeeded with mujoco, as expected."
          else
            echo "cargo check failed with mujoco, which is unexpected."
            exit 1
          fi
